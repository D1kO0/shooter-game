<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Top-Down Shooter — Full Rebuild</title>
<style>
:root{
  --bg:#071028; --panel:#0f1724; --accent:#f97316; --muted:#9aa4b2;
  --text:#dff3ff;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#021524);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:var(--text)}
.wrap{display:grid;grid-template-columns:1fr 360px;gap:16px;padding:16px;height:100vh}
.game{position:relative;border-radius:12px;overflow:hidden;background:linear-gradient(180deg,#061726,#04122a);box-shadow:0 8px 40px rgba(0,0,0,0.6)}
canvas{width:100%;height:100%;display:block}
.panel{padding:14px;border-radius:12px;background:linear-gradient(180deg,var(--panel),#071426);box-shadow:0 8px 30px rgba(0,0,0,0.6)}
.hud{position:absolute;left:14px;top:14px;background:rgba(0,0,0,0.28);backdrop-filter:blur(6px);padding:8px 12px;border-radius:10px;font-weight:600}
.controls{font-size:13px;color:var(--muted)}
.btn{display:inline-block;padding:8px 10px;border-radius:8px;background:linear-gradient(90deg,var(--accent),#ffb379);color:#02111b;border:none;cursor:pointer;font-weight:700;margin-top:8px}
.small{font-size:13px;color:var(--muted)}
.stat{display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px;margin-bottom:8px}
.bar{height:10px;background:rgba(255,255,255,0.06);border-radius:10px;overflow:hidden}
.bar > i{display:block;height:100%;background:linear-gradient(90deg,#ffd7a8,var(--accent));width:100%}
.center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
.card{pointer-events:auto;background:rgba(2,6,12,0.9);padding:14px;border-radius:12px;text-align:center;min-width:280px}
.shop-item{display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px;margin-bottom:8px}
footer{position:absolute;right:12px;bottom:10px;color:var(--muted);font-size:12px}
@media (max-width:920px){.wrap{grid-template-columns:1fr}.panel{width:100%}}
</style>
</head>
<body>
<div class="wrap">
  <div class="game" id="gameWrap">
    <!-- Canvas will be sized by JS to full area for crisp resolution -->
    <canvas id="canvas"></canvas>
    <div class="hud" id="hud">HP: <span id="hp">100</span> • Score: <span id="score">0</span> • $: <span id="money">0</span></div>
    <div class="center" id="center">
      <div class="card" id="centerCard">
        <h2 style="margin:0 0 6px">Top-Down Shooter</h2>
        <div class="small" style="margin-bottom:10px">WASD — движение • Мышь — прицел • ЛКМ — стрелять • P — магазин • R — перезапуск</div>
        <div style="display:flex;gap:8px;justify-content:center">
          <button class="btn" id="startBtn">Начать</button>
          <button class="btn" id="loadBtn">Загрузить</button>
        </div>
      </div>
    </div>
    <footer>Full rebuild — HTML/CSS/JS — сохранение в localStorage</footer>
  </div>

  <aside class="panel">
    <h3 style="margin:0 0 8px">Статистика и магазин</h3>
    <div class="small meta" style="margin-bottom:10px">Враги: Grunt, Runner, Tank, Shooter, Boss. Магазин открывается между волнами или клавишей P.</div>

    <div class="stat"><div>HP</div><div id="statHP">100</div></div>
    <div class="stat"><div>Score</div><div id="statScore">0</div></div>
    <div class="stat"><div>Money</div><div id="statMoney">0</div></div>

    <div style="margin:10px 0">
      <div class="small">HP bar</div>
      <div class="bar" style="margin-top:6px"><i id="hpBar" style="width:100%"></i></div>
    </div>

    <div style="margin-top:8px"><b>Апгрейды</b>
      <div id="upgradeList" class="small" style="margin-top:6px;color:var(--muted)">— нет —</div>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="openShopBtn">Открыть магазин (P)</button>
      <button class="btn" id="saveBtn">Сохранить</button>
      <button class="btn" id="resetBtn">Сбросить прогресс</button>
    </div>

    <div id="shopPanel" style="display:none;margin-top:12px">
      <h4 style="margin:0 0 8px">Магазин (между волнами)</h4>
      <div id="shopItems"></div>
    </div>
    <div style="margin-top:12px;font-size:13px;color:var(--muted)">
      Совет: покупай апгрейды между волнами, собирай пауэр-апы в бою.
    </div>
  </aside>
</div>

<script>
/*
  Top-Down Shooter — full rebuild
  - Reliable input: e.code for WASD (KeyW/KeyA/KeyS/KeyD)
  - Enemy types, boss, shop, powerups
  - WebAudio-generated sound effects
  - Save/Load to localStorage
  - No external libs
*/

'use strict';

// ----- Canvas setup (high DPI friendly) -----
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
function resizeCanvasToDisplaySize() {
  const wrap = document.getElementById('gameWrap');
  const rect = wrap.getBoundingClientRect();
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  canvas.width = Math.round(rect.width * dpr);
  canvas.height = Math.round(rect.height * dpr);
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}
window.addEventListener('resize', resizeCanvasToDisplaySize);
resizeCanvasToDisplaySize();

// ----- UI refs -----
const hudHP = document.getElementById('hp');
const hudScore = document.getElementById('score');
const hudMoney = document.getElementById('money');
const statHP = document.getElementById('statHP');
const statScore = document.getElementById('statScore');
const statMoney = document.getElementById('statMoney');
const hpBar = document.getElementById('hpBar');
const center = document.getElementById('center');
const centerCard = document.getElementById('centerCard');
const startBtn = document.getElementById('startBtn');
const loadBtn = document.getElementById('loadBtn');
const openShopBtn = document.getElementById('openShopBtn');
const shopPanel = document.getElementById('shopPanel');
const shopItems = document.getElementById('shopItems');
const saveBtn = document.getElementById('saveBtn');
const resetBtn = document.getElementById('resetBtn');
const upgradeList = document.getElementById('upgradeList');

// ----- Input (fixed WASD using e.code) -----
const input = {
  keys: {},
  mouse: {x:0,y:0,down:false}
};

window.addEventListener('keydown', (e) => {
  // avoid interfering with text inputs in future UX
  input.keys[e.code] = true;
  // shortcuts
  if (e.code === 'KeyP') toggleShop();
  if (e.code === 'KeyR') restartGame();
});
window.addEventListener('keyup', (e) => {
  input.keys[e.code] = false;
});
canvas.addEventListener('mousemove', (e) => {
  const r = canvas.getBoundingClientRect();
  const scaleX = canvas.width / r.width;
  const scaleY = canvas.height / r.height;
  // We'll store mouse in CSS pixels for aiming calculations (consistent)
  input.mouse.x = (e.clientX - r.left);
  input.mouse.y = (e.clientY - r.top);
});
canvas.addEventListener('mousedown', (e) => { input.mouse.down = true; });
window.addEventListener('mouseup', (e) => { input.mouse.down = false; });
// touch support
canvas.addEventListener('touchstart', (e) => {
  if (e.touches.length) {
    const r = canvas.getBoundingClientRect();
    input.mouse.x = e.touches[0].clientX - r.left;
    input.mouse.y = e.touches[0].clientY - r.top;
    input.mouse.down = true;
  }
  e.preventDefault();
}, {passive:false});
canvas.addEventListener('touchmove', (e) => {
  if (e.touches.length) {
    const r = canvas.getBoundingClientRect();
    input.mouse.x = e.touches[0].clientX - r.left;
    input.mouse.y = e.touches[0].clientY - r.top;
  }
  e.preventDefault();
}, {passive:false});
canvas.addEventListener('touchend', (e) => { input.mouse.down = false; e.preventDefault(); }, {passive:false});

// ----- Utilities -----
function rand(min, max){ return Math.random()*(max-min)+min; }
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function dist(a,b){ return Math.hypot((a.x||a.cx)-(b.x||b.cx),(a.y||a.cy)-(b.y||b.cy)); }
function now(){ return performance.now(); }

// ----- WebAudio simple manager (no files) -----
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
function ensureAudioCtx() {
  if(!audioCtx) {
    try { audioCtx = new AudioCtx(); } catch(e) { audioCtx = null; }
  }
}
function sfxShot(){
  ensureAudioCtx();
  if(!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'square';
  o.frequency.setValueAtTime(1000, audioCtx.currentTime);
  g.gain.setValueAtTime(0.06, audioCtx.currentTime);
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  o.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.12);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.14);
  o.stop(audioCtx.currentTime + 0.15);
}
function sfxHit(){
  ensureAudioCtx();
  if(!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type='sawtooth';
  o.frequency.setValueAtTime(220, audioCtx.currentTime);
  g.gain.setValueAtTime(0.06, audioCtx.currentTime);
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  o.frequency.exponentialRampToValueAtTime(120, audioCtx.currentTime + 0.12);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.14);
  o.stop(audioCtx.currentTime + 0.16);
}
function sfxPickup(){
  ensureAudioCtx();
  if(!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type='sine';
  o.frequency.setValueAtTime(700, audioCtx.currentTime);
  g.gain.setValueAtTime(0.06, audioCtx.currentTime);
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  o.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.18);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.22);
  o.stop(audioCtx.currentTime + 0.25);
}

// simple ambient music (very light)
let musicNodes = null;
function startMusic(){
  ensureAudioCtx();
  if(!audioCtx || musicNodes) return;
  const o1 = audioCtx.createOscillator();
  const o2 = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o1.type='sine'; o2.type='sine';
  o1.frequency.value = 90; o2.frequency.value = 150;
  g.gain.value = 0.007;
  o1.connect(g); o2.connect(g); g.connect(audioCtx.destination);
  o1.start(); o2.start();
  musicNodes = {o1,o2,g};
}
function stopMusic(){
  if(!musicNodes) return;
  try { musicNodes.o1.stop(); musicNodes.o2.stop(); } catch(e){}
  musicNodes = null;
}

// ----- Game entities -----
class Player {
  constructor(x,y){
    this.x = x; this.y = y; this.r = 16;
    this.color = '#9bd1ff';
    this.speed = 180; // pixels per second
    this.hp = 120; this.maxHp = 120;
    this.fireRate = 220; this._lastShot = 0;
    this.shotType = 'single'; // 'single' or 'shotgun'
    this.score = 0; this.money = 0;
    this.shieldTime = 0;
  }
  update(dt){
    let vx = 0, vy = 0;
    if(input.keys['KeyW']) vy -= 1;
    if(input.keys['KeyS']) vy += 1;
    if(input.keys['KeyA']) vx -= 1;
    if(input.keys['KeyD']) vx += 1;
    const len = Math.hypot(vx,vy) || 1;
    this.x += (vx/len) * this.speed * dt;
    this.y += (vy/len) * this.speed * dt;
    // clamp inside canvas rectangle (CSS pixels)
    const w = canvas.clientWidth, h = canvas.clientHeight;
    this.x = clamp(this.x, this.r, w - this.r);
    this.y = clamp(this.y, this.r, h - this.r);

    // shooting
    if(input.mouse.down){
      const t = now();
      if(t - this._lastShot >= this.fireRate){
        this.shoot();
        this._lastShot = t;
      }
    }

    if(this.shieldTime > 0) this.shieldTime = Math.max(0, this.shieldTime - dt);
  }
  shoot(){
    const tx = input.mouse.x, ty = input.mouse.y;
    const angle = Math.atan2(ty - this.y, tx - this.x);
    if(this.shotType === 'single'){
      const speed = 800;
      bullets.push(new Bullet(this.x + Math.cos(angle)*(this.r+6), this.y + Math.sin(angle)*(this.r+6), Math.cos(angle)*speed, Math.sin(angle)*speed, 'player', 12));
      sfxShot();
    } else if(this.shotType === 'shotgun'){
      const pellets = 6;
      for(let i=0;i<pellets;i++){
        const a = angle + rand(-0.36, 0.36);
        const speed = 620;
        bullets.push(new Bullet(this.x + Math.cos(a)*(this.r+6), this.y + Math.sin(a)*(this.r+6), Math.cos(a)*speed, Math.sin(a)*speed, 'player', 10));
      }
      sfxShot();
    }
  }
  draw(ctx){
    // shadow
    ctx.save();
    ctx.beginPath(); ctx.ellipse(this.x, this.y+6, this.r+6, 6, 0, 0, Math.PI*2); ctx.fillStyle='rgba(0,0,0,0.22)'; ctx.fill();
    // body
    ctx.beginPath(); ctx.arc(this.x, this.y, this.r, 0, Math.PI*2); ctx.fillStyle = this.color; ctx.fill();
    // gun (simple)
    const angle = Math.atan2(input.mouse.y - this.y, input.mouse.x - this.x);
    ctx.translate(this.x, this.y); ctx.rotate(angle);
    ctx.fillStyle = '#072033'; ctx.fillRect(10, -5, 18, 10);
    ctx.restore();
    if(this.shieldTime > 0){
      ctx.beginPath(); ctx.arc(this.x, this.y, this.r+8, 0, Math.PI*2); ctx.strokeStyle='rgba(140,200,255,0.6)'; ctx.lineWidth=3; ctx.stroke();
    }
  }
}

class Bullet {
  constructor(x,y,vx,vy,owner,dmg){
    this.x=x; this.y=y; this.vx=vx; this.vy=vy; this.owner=owner; this.dmg=dmg||10; this.r=4; this.life=2.2;
  }
  update(dt){
    this.x += this.vx * dt;
    this.y += this.vy * dt;
    this.life -= dt;
  }
  draw(ctx){
    ctx.beginPath(); ctx.arc(this.x, this.y, this.r, 0, Math.PI*2);
    ctx.fillStyle = (this.owner==='player') ? '#ffeb8a' : '#ff8a8a';
    ctx.fill();
  }
}

class Enemy {
  constructor(x,y,type){
    this.x=x; this.y=y; this.type=type;
    // default stats per type
    const types = {
      grunt: {r:14, spd:60, hp:28, color:'#ff7b7b', reward:12},
      runner:{r:10, spd:150, hp:12, color:'#ffd27b', reward:9},
      tank:  {r:18, spd:40, hp:80, color:'#b28cff', reward:40, armor:8},
      shooter:{r:14, spd:55, hp:26, color:'#ffd9a3', reward:14, shoot:true},
      boss:  {r:42, spd:28, hp:520, color:'#ff7aa6', reward:260}
    };
    const t = types[type] || types.grunt;
    this.r = t.r; this.spd = t.spd; this.hp = t.hp; this.color = t.color; this.reward = t.reward; this.armor = t.armor||0;
    this.shoot = !!t.shoot; this.timer = 0; this.shootInterval = 1.8;
  }
  update(dt){
    const angle = Math.atan2(player.y - this.y, player.x - this.x);
    this.x += Math.cos(angle) * this.spd * dt;
    this.y += Math.sin(angle) * this.spd * dt;
    // if shooter -> maybe fire
    if(this.shoot){
      this.timer += dt;
      if(this.timer >= this.shootInterval){
        this.timer = 0;
        const speed = 300;
        const a = Math.atan2(player.y - this.y, player.x - this.x);
        bullets.push(new Bullet(this.x + Math.cos(a)*(this.r+6), this.y + Math.sin(a)*(this.r+6), Math.cos(a)*speed, Math.sin(a)*speed, 'enemy', 10));
      }
    }
  }
  draw(ctx){
    ctx.beginPath(); ctx.arc(this.x, this.y, this.r, 0, Math.PI*2); ctx.fillStyle = this.color; ctx.fill();
    // HP small
    ctx.fillStyle = 'rgba(0,0,0,0.25)';
    ctx.fillRect(this.x - this.r, this.y - this.r - 8, (this.r*2) * Math.max(0, this.hp/100), 4);
  }
}

// Particles & PowerUps
class Particle {
  constructor(x,y,vx,vy,life,color){
    this.x=x; this.y=y; this.vx=vx; this.vy=vy; this.life=life; this.max=life; this.color=color||'#ffd8a8';
  }
  update(dt){ this.x += this.vx*dt; this.y += this.vy*dt; this.life -= dt; }
  draw(ctx){ const t = clamp(this.life/this.max,0,1); ctx.globalAlpha = t; ctx.beginPath(); ctx.arc(this.x,this.y, (3*t)+1, 0, Math.PI*2); ctx.fillStyle = this.color; ctx.fill(); ctx.globalAlpha = 1; }
}

class PowerUp {
  constructor(x,y,kind){
    this.x=x; this.y=y; this.kind=kind; this.r=10; this.timer=12;
    // kind: 'health','rapid','shield'
  }
  update(dt){ this.timer -= dt; }
  draw(ctx){
    ctx.beginPath(); ctx.arc(this.x,this.y,this.r,0,Math.PI*2);
    if(this.kind==='health') ctx.fillStyle='#7bff9b';
    else if(this.kind==='rapid') ctx.fillStyle='#ffd27b';
    else ctx.fillStyle='#9bd1ff';
    ctx.fill();
  }
}

// ----- Game state -----
let player = null;
let bullets = [];
let enemies = [];
let particles = [];
let powerups = [];

let game = {
  running: false,
  lastTime: 0,
  spawnTimer: 0,
  spawnInterval: 1200,
  wave: 0,
  inShop: false,
  wavesBeforeShop: 3,
  difficulty: 'normal' // easy, normal, hard
};

// ----- Shop catalog -----
const shopCatalog = [
  {id:'shotgun', name:'Shotgun', desc:'6 дробных снарядов', cost:140, apply: g=>{ player.shotType = 'shotgun'; }},
  {id:'rapid', name:'Ускорить стрельбу', desc:'-100ms', cost:120, apply: g=>{ player.fireRate = Math.max(80, player.fireRate - 100); }},
  {id:'speed', name:'Speed +40', desc:'+40 к скорости', cost:100, apply: g=>{ player.speed += 40; }},
  {id:'hpmax', name:'Max HP +40', desc:'увеличение HP', cost:120, apply: g=>{ player.maxHp += 40; player.hp += 40; }},
  {id:'shield', name:'Щит 8s', desc:'щит на 8 секунд', cost:160, apply: g=>{ player.shieldTime = 8; }},
  {id:'heal', name:'Хил +60', desc:'+60 HP', cost:80, apply: g=>{ player.hp = Math.min(player.maxHp, player.hp + 60); }}
];

// ----- Spawn logic -----
function spawnEnemyAtEdge(type){
  const Ww = canvas.clientWidth, Hh = canvas.clientHeight;
  const side = Math.floor(rand(0,4));
  let x,y;
  if(side===0){ x = rand(-60, -10); y = rand(0, Hh); }
  else if(side===1){ x = rand(Ww + 10, Ww + 60); y = rand(0, Hh); }
  else if(side===2){ x = rand(0, Ww); y = rand(-60, -10); }
  else { x = rand(0, Ww); y = rand(Hh + 10, Hh + 60); }
  enemies.push(new Enemy(x,y,type));
}

function spawnWave(){
  game.wave++;
  // spawn count influenced by difficulty
  const base = 3 + Math.floor(game.wave * 0.6);
  let count = base + (game.difficulty==='hard'? 2 : game.difficulty==='easy'? -1 : 0);
  for(let i=0;i<count;i++){
    const r = Math.random();
    if(r < 0.5) spawnEnemyAtEdge('grunt');
    else if(r < 0.75) spawnEnemyAtEdge('runner');
    else if(r < 0.9) spawnEnemyAtEdge('tank');
    else spawnEnemyAtEdge('shooter');
  }
  // boss occasionally
  if(game.wave % 5 === 0) spawnEnemyAtEdge('boss');
}

// ----- Powerups & drops -----
function spawnPowerUp(x,y){
  const r = Math.random();
  const kind = (r < 0.45) ? 'health' : (r < 0.75 ? 'rapid' : 'shield');
  powerups.push(new PowerUp(x,y,kind));
}

// ----- Particles -----
function spawnParticles(x,y,color,amount=7){
  for(let i=0;i<amount;i++){
    particles.push(new Particle(x,y, rand(-140,140), rand(-140,140), rand(0.4,0.9), color));
  }
}

// ----- HUD update -----
function updateHUD(){
  hudHP.textContent = Math.max(0, Math.floor(player.hp));
  hudScore.textContent = player.score;
  hudMoney.textContent = player.money;
  statHP.textContent = Math.max(0, Math.floor(player.hp));
  statScore.textContent = player.score;
  statMoney.textContent = player.money;
  hpBar.style.width = Math.max(0, (player.hp / player.maxHp * 100)) + '%';
  // upgrades list
  const ups = [];
  if(player.shotType === 'shotgun') ups.push('Shotgun');
  if(player.fireRate < 220) ups.push('Rapid fire');
  if(player.speed > 220) ups.push('Speed');
  if(player.maxHp > 120) ups.push('Max HP');
  if(player.shieldTime > 0) ups.push('Shield');
  upgradeList.textContent = ups.length ? ups.join(', ') : '— нет —';
}

// ----- Game loop -----
let rafId = null;
function gameLoop(ts){
  if(!game.running) return;
  if(!game.lastTime) game.lastTime = ts;
  const dt = Math.min(0.05, (ts - game.lastTime) / 1000);
  game.lastTime = ts;
  step(dt);
  render();
  rafId = requestAnimationFrame(gameLoop);
}

function step(dt){
  // player
  player.update(dt);
  // bullets
  for(let i=bullets.length-1;i>=0;i--){
    bullets[i].update(dt);
    if(bullets[i].life <= 0) bullets.splice(i,1);
  }
  // enemies
  for(let i=enemies.length-1;i>=0;i--){
    const e = enemies[i];
    e.update(dt);
    // collision with player
    if(dist(e, player) < e.r + player.r){
      if(player.shieldTime <= 0){
        player.hp -= (e.type==='tank' ? 12 : 8) * dt * 6; // damage over time
      }
      // pushback
      const dx = e.x - player.x, dy = e.y - player.y;
      const d = Math.hypot(dx,dy) || 1;
      e.x += (dx/d) * 30 * dt; e.y += (dy/d) * 30 * dt;
    }
  }
  // bullets vs enemies & player
  for(let i=bullets.length-1;i>=0;i--){
    const b = bullets[i];
    if(b.owner === 'player'){
      for(let j=enemies.length-1;j>=0;j--){
        const e = enemies[j];
        if(dist(b,e) < b.r + e.r){
          // apply damage
          let dmg = b.dmg;
          if(e.armor) dmg = Math.max(1, dmg - e.armor);
          e.hp -= dmg;
          spawnParticles(b.x,b.y,'#ffd8a8',6);
          sfxHit();
          bullets.splice(i,1);
          if(e.hp <= 0){
            // reward
            player.money += e.reward;
            player.score += e.reward;
            // drop powerup sometimes
            if(Math.random() < 0.25) spawnPowerUp(e.x, e.y);
            spawnParticles(e.x, e.y, '#ffb3b3', 12);
            enemies.splice(j,1);
            sfxPickup();
          }
          break;
        }
      }
    } else {
      // enemy bullet hits player
      if(dist(b, player) < b.r + player.r){
        if(player.shieldTime <= 0) player.hp -= b.dmg;
        bullets.splice(i,1);
        sfxHit();
      }
    }
  }

  // particles
  for(let i=particles.length-1;i>=0;i--){
    particles[i].update(dt);
    if(particles[i].life <= 0) particles.splice(i,1);
  }

  // powerups
  for(let i=powerups.length-1;i>=0;i--){
    const p = powerups[i];
    p.update(dt);
    if(p.timer <= 0){ powerups.splice(i,1); continue; }
    if(dist(p, player) < p.r + player.r){
      if(p.kind === 'health') player.hp = Math.min(player.maxHp, player.hp + 45);
      else if(p.kind === 'rapid'){ player.fireRate = Math.max(80, player.fireRate - 120); setTimeout(()=>{ player.fireRate = Math.min(player.fireRate + 120, 250); }, 9000); }
      else if(p.kind === 'shield'){ player.shieldTime = 6; }
      powerups.splice(i,1);
      sfxPickup();
    }
  }

  // spawn routine when not in shop
  if(!game.inShop){
    game.spawnTimer += dt * 1000;
    if(game.spawnTimer >= game.spawnInterval){
      game.spawnTimer = 0;
      spawnWave();
      // occasional extra
      if(Math.random() < 0.35) spawnWave();
    }
  }

  // acceleration of difficulty with waves
  if(enemies.length === 0 && !game.inShop){
    // small delay before next wave entry into shop
    if(now() - game.lastWaveEnd > 750 && game.spawnTimer > 100){
      // next wave will be scheduled (spawnWave handles progression)
      // if it's time for shop
      if(game.wave > 0 && game.wave % game.wavesBeforeShop === 0){
        enterShop();
      } else {
        // immediate spawn next wave
        spawnWave();
      }
      game.lastWaveEnd = now();
    }
  }

  // death
  if(player.hp <= 0 && game.running){
    game.running = false;
    stopMusic();
    showCenter(`Вы проиграли<br>Счёт: ${player.score}<br><div style="margin-top:8px"><button class="btn" id="respawnBtn">Играть снова</button></div>`);
    // attach button handler safely
    setTimeout(()=>{ const b = document.getElementById('respawnBtn'); if(b) b.addEventListener('click', ()=>{ restartGame(); }); }, 20);
  }

  updateHUD();
}

// ----- Render -----
function render(){
  const Ww = canvas.clientWidth, Hh = canvas.clientHeight;
  ctx.clearRect(0,0,Ww,Hh);
  // subtle grid background
  ctx.save();
  ctx.globalAlpha = 0.06;
  ctx.strokeStyle = '#ffffff';
  ctx.lineWidth = 1;
  for(let x=0;x<Ww;x+=48){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,Hh); ctx.stroke(); }
  for(let y=0;y<Hh;y+=48){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(Ww,y); ctx.stroke(); }
  ctx.restore();

  // draw items in order
  for(const p of powerups) p.draw(ctx);
  for(const pt of particles) pt.draw(ctx);
  for(const e of enemies) e.draw(ctx);
  for(const b of bullets) b.draw(ctx);
  player.draw(ctx);
}

// ----- UI center handling -----
function showCenter(html){
  center.style.display = 'flex';
  centerCard.innerHTML = html;
  centerCard.style.pointerEvents = 'auto';
}
function hideCenter(){
  center.style.display = 'none';
  centerCard.innerHTML = '';
}

// ----- Shop UI -----
function openShopUI(){
  game.inShop = true;
  shopPanel.style.display = 'block';
  shopItems.innerHTML = '';
  for(const it of shopCatalog){
    const div = document.createElement('div'); div.className = 'shop-item';
    const left = document.createElement('div'); left.innerHTML = `<b>${it.name}</b><div style="font-size:12px;color:var(--muted)">${it.desc}</div>`;
    const right = document.createElement('div'); right.innerHTML = `<div style="text-align:right">$${it.cost}</div>`;
    const btn = document.createElement('button'); btn.className = 'btn'; btn.textContent = 'Купить';
    btn.addEventListener('click', ()=>{
      if(player.money < it.cost){ alert('Недостаточно денег'); return; }
      player.money -= it.cost;
      it.apply(game);
      updateHUD();
      // remove item if one-time? keep it for demo
    });
    right.appendChild(btn);
    div.appendChild(left); div.appendChild(right);
    shopItems.appendChild(div);
  }
}
function closeShopUI(){
  game.inShop = false;
  shopPanel.style.display = 'none';
}
function toggleShop(){
  if(game.inShop) closeShopUI(); else openShopUI();
}

// ----- Shop entry logic between waves -----
function enterShop(){
  game.inShop = true;
  openShopUI();
  showCenter(`<h3>Магазин</h3><div class="small" style="margin-top:8px">Покупайте улучшения</div><div style="margin-top:10px"><button class="btn" id="continueBtn">Продолжить</button></div>`);
  // Give small reward when entering shop
  player.money += Math.floor(game.wave * 6 + 20);
  setTimeout(()=>{ const cb = document.getElementById('continueBtn'); if(cb) cb.addEventListener('click', ()=>{ hideCenter(); closeShopUI(); spawnWave(); startMusic(); game.inShop = false; }); }, 20);
}

// ----- Save / Load -----
const SAVE_KEY = 'topdown_saved_v1';
function saveProgress(){
  const data = {
    money: player.money,
    score: player.score,
    upgrades: {
      shotType: player.shotType,
      fireRate: player.fireRate,
      speed: player.speed,
      maxHp: player.maxHp
    },
    wave: game.wave
  };
  try { localStorage.setItem(SAVE_KEY, JSON.stringify(data)); alert('Сохранено'); } catch(e){ alert('Ошибка сохранения'); }
}
function loadProgress(){
  try {
    const raw = localStorage.getItem(SAVE_KEY);
    if(!raw) { alert('Нет сохранений'); return; }
    const data = JSON.parse(raw);
    player.money = data.money || player.money;
    player.score = data.score || player.score;
    if(data.upgrades){
      player.shotType = data.upgrades.shotType || player.shotType;
      player.fireRate = data.upgrades.fireRate || player.fireRate;
      player.speed = data.upgrades.speed || player.speed;
      player.maxHp = data.upgrades.maxHp || player.maxHp;
    }
    game.wave = data.wave || game.wave;
    updateHUD();
    alert('Загружено');
  } catch(e){ alert('Ошибка загрузки'); }
}
function resetProgress(){
  if(confirm('Сбросить сохранение и прогресс?')){ localStorage.removeItem(SAVE_KEY); location.reload(); }
}

// ----- Game control helpers -----
function startGame(){
  // init player etc
  const cw = canvas.clientWidth, ch = canvas.clientHeight;
  player = new Player(cw/2, ch/2);
  bullets = []; enemies = []; particles = []; powerups = [];
  game.running = true;
  game.lastTime = 0;
  game.spawnTimer = 0;
  game.wave = 0;
  hideCenter();
  spawnWave();
  startMusic();
  if(rafId) cancelAnimationFrame(rafId);
  rafId = requestAnimationFrame(gameLoop);
}
function restartGame(){
  stopMusic();
  startGame();
}
function showWelcome(){
  center.style.display = 'flex';
  centerCard.innerHTML = `<h2 style="margin:0 0 8px">Top-Down Shooter</h2>
    <div class="small" style="margin-bottom:10px">WASD — движение • Мышь — прицел • ЛКМ — стрелять • P — магазин • R — перезапуск</div>
    <div style="display:flex;gap:8px;justify-content:center">
      <button class="btn" id="startNow">Начать</button>
      <button class="btn" id="loadNow">Загрузить</button>
    </div>`;
  // attach handlers
  setTimeout(()=>{
    const s = document.getElementById('startNow'); if(s) s.addEventListener('click', ()=>{ startGame(); });
    const l = document.getElementById('loadNow'); if(l) l.addEventListener('click', ()=>{ loadProgress(); });
  }, 20);
}

// ----- Helpers for spawning bullets via other code scope -----
// Expose a simple function to spawn enemy bullets when needed
function enemyShoot(x,y,tx,ty,spd=300){
  const a = Math.atan2(ty-y, tx-x);
  bullets.push(new Bullet(x + Math.cos(a)*(6), y + Math.sin(a)*(6), Math.cos(a)*spd, Math.sin(a)*spd, 'enemy', 10));
}

// ----- Event handlers for UI -----
startBtn.addEventListener('click', ()=>{ startGame(); });
loadBtn.addEventListener('click', ()=>{ loadProgress(); });
openShopBtn.addEventListener('click', ()=>{ toggleShop(); });
saveBtn.addEventListener('click', saveProgress);
resetBtn.addEventListener('click', resetProgress);

// ----- initial preview (safe) -----
player = new Player(canvas.clientWidth/2, canvas.clientHeight/2);
updateHUD();
showWelcome();

// ----- Ensure keyboard focus works for WASD (explanation) -----
// We use `e.code` instead of `e.key` or characters — this avoids issues when keyboard layout is not English.
// Example: 'KeyW' is the same physical key regardless of layout.

// This completes the rebuild. If you see any specific browser console error, paste it here and я исправлю.
// Enjoy — WASD теперь надёжно работает.
</script>
</body>
</html>
